<!doctype html>
<html lang="en-us">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Unity WebGL Player | ShiftAtMidnight</title>

	<style>
		html, body {
			margin: 0;
			padding: 0;
			overflow: hidden;
			height: 100%;
			width: 100%;
			background: black;
		}

		#unity-container,
		#unity-canvas {
			width: 100%;
			height: 100%;
			position: fixed;
			top: 0;
			left: 0;
		}

		#loading-text {
			color: white;
			font-family: Inter, sans-serif;
			font-size: 32px;
			text-align: center;
			position: absolute;
			top: 40%;
			width: 100%;
			z-index: 5;
		}

		#start-button {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			padding: 20px 50px;
			font-size: 24px;
			background: white;
			border: none;
			cursor: pointer;
			z-index: 10;
		}

		#start-button:hover {
			background: #ddd;
		}
	</style>
</head>

<body>

	<div id="loading-text">Click to Start</div>
	<button id="start-button">Start Game</button>

	<div id="unity-container">
		<canvas id="unity-canvas" tabindex="-1"></canvas>
	</div>

	<script>
		function mergeFiles(fileParts) {
			return new Promise((resolve, reject) => {
				let buffers = [];

				function fetchPart(index) {
					if (index >= fileParts.length) {
						let mergedBlob = new Blob(buffers);
						resolve(URL.createObjectURL(mergedBlob));
						return;
					}

					fetch(fileParts[index])
						.then(response => response.arrayBuffer())
						.then(data => {
							buffers.push(data);
							document.getElementById("loading-text").textContent =
								`Parts downloaded (${index + 1}/${fileParts.length})`;
							fetchPart(index + 1);
						})
						.catch(reject);
				}

				fetchPart(0);
			});
		}

		function getParts(file, start, end) {
			let parts = [];
			for (let i = start; i <= end; i++) {
				parts.push(file + ".part" + i);
			}
			return parts;
		}

		document.getElementById("start-button").addEventListener("click", function () {

			// Remove button after click (unlocks browser audio)
			this.remove();

			document.getElementById("loading-text").textContent = "Loading...";

			Promise.all([
				mergeFiles(getParts("Build/ShiftAtMidnightPort.data", 1, 5)),
				mergeFiles(getParts("Build/ShiftAtMidnightPort.wasm", 1, 2)),
			]).then(([dataUrl, wasmUrl]) => {

				var buildUrl = "Build";
				var config = {
					dataUrl: dataUrl,
					frameworkUrl: buildUrl + "/ShiftAtMidnightPort.framework.js",
					codeUrl: wasmUrl,
					streamingAssetsUrl: "StreamingAssets",
					companyName: "slqntdevss",
					productName: "ShiftAtMidnight",
					productVersion: "1.00",
				};

				var loaderScript = document.createElement("script");
				loaderScript.src = buildUrl + "/ShiftAtMidnightPort.loader.js";

				loaderScript.onload = () => {
					createUnityInstance(
						document.getElementById("unity-canvas"),
						config,
						(progress) => {
							document.getElementById("loading-text").textContent =
								"Loading... " + Math.round(progress * 100) + "%";
						}
					).then(() => {
						document.getElementById("loading-text").remove();
					}).catch((message) => {
						alert(message);
					});
				};

				document.body.appendChild(loaderScript);
			});
		});
	</script>

</body>
</html>
